<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Mesh Secure Ingress Traffic Flow :: Red Hat Service Mesh - Troubleshooting</title>
    <link rel="canonical" href="http://localhost:3000/rhs-build-course/index.html/rh-service-mesh-v2-troubleshooting/05-secure-ingress-traffic.html">
    <link rel="prev" href="04-ingress-traffic.html">
    <link rel="next" href="06-egress-traffic.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="http://localhost:3000/rhs-build-course/index.html">Red Hat Service Mesh - Troubleshooting</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rh-service-mesh-v2-troubleshooting" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Red Hat Service Mesh - Troubleshooting</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#laboratory">1.2 Laboratory</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-jumpapp.html">2. Jump App Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#login">2.1 Login in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#github">2.2 Clone GitHub Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#jumpappobjects">2.3 Create Jump App Objects in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#test">2.4 Confirm Jump App is already running in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#testapp">2.5 Access to Jump App</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-flows.html">3. Service Mesh Communication Flows</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-flows.html#create">3.1 Create Red Hat Service Mesh Traffic Flow objects</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#gw">3.1.1 Gateways</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#vsvc">3.1.2 Virtual Services</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#dr">3.1.3 Destination Rules</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#services">3.1.4 K8s Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-flows.html#memberrol">3.2 Added a new project to Red Hat Service Mesh Control Plane</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-flows.html#finalsteps">3.3 Final steps</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#annotation">3.3.1 Add Istio Sidecar annotation in Jump App deployments</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-flows.html#routes">3.3.2 Configure Routes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-flows.html#test">3.4 Confirm Jump App is running again</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-flows.html#03-kiali">3.5 Visit Kiali</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-ingress-traffic.html">4. Service Mesh Ingress Traffic Flow</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-ingress-traffic.html#04-ingress">4.1 Introduction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-ingress-traffic.html#04-troubleshooting">4.2 Ingress Gateway Traffic Flow Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-ingress-traffic.html#04-customize">4.3 Customize Jump App</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-cust-state">4.3.1 Confirm <em>Jump App</em> state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-ingress-traffic.html#04-router">4.4 Openshift Router &#8594; Ingress Gateway Connectivity</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-trou-con">4.4.1 Test connectivity via command line</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-trou-fix">4.4.2 Fix configuration problems</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-trou-con-again">4.4.3 Test connectivity again via command line</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway">4.5 Ingress Gateway &#8594; Sidecar Connectivity</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway-con">4.5.1 Test connectivity via command line</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway-fix">4.5.2 Fix configuration problems</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway-con-again">4.5.3 Test connectivity again via command line</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway-fix2">4.5.4 Fix configuration problems</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-gateway-con-again2">4.5.5 Test connectivity again via command line</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-ingress-traffic.html#04-sidecar">4.6 Sidecar &#8594; App Connectivity</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-ingress-traffic.html#04-sidecar-con">4.6.1 Test connectivity via command line</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-ingress-traffic.html#04-test">4.7 Confirm <em>Jump App</em> is running again</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-ingress-traffic.html#04-kiali">4.8 Visit Kiali</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-secure-ingress-traffic.html">5. Secure Ingress Traffic Troubleshooting</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#05-sds">5.1 Secure Gateways with SDS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-sds-addcert">5.1.1 Create in Istio the Custom Certificate using SDS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-sds-route">5.1.2 Modify back-golang Route in istio-system Namespace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-sds-gw">5.1.3 Configure Gateway</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#05-test-fail">5.2 Confirm <em>Jump App</em> is running</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#05-router">5.3 Openshift Router &#8594; Ingress Gateway Secure Connectivity</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-con">5.3.1 Test connectivity via command line</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-fix">5.3.2 Fix configuration problems</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-fix">5.3.3 Fix configuration problems</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#05-gateway">5.4 Ingress Gateway &#8594; Envoy Sidecar Secure Connectivity</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-gateway-forcessl">5.4.1 Force mTLS in your namespace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-gateway-con">5.4.2 Test connectivity via command line</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#05-trou-gateway-evoy-con">5.4.3 Emulate regular <em>Ingress Gateway</em> connectivity via command line</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#05-test">5.5 Confirm <em>Jump App</em> is running again</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#05-kiali">5.5 Visit Kiali</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-egress-traffic.html">6. Egress Traffic Troubleshooting</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-egress-traffic.html#06-sds">6.1 Secure Egress Traffic with mTLS</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-egress-traffic.html#06-createservice">6.2 Create the <em>External Service</em></a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-addcert">6.2.1 Add a Custom Certificate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-createnginx">6.2.2 Create Nginx service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-egress-traffic.html#06-createtesting">6.3 Create the Testing Microservice</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-createtestingcerts">6.3.1 Add a Custom Certificate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-createtestingdepl">6.3.2 Create Testing Tool Deployment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-createsevs">6.3.3 Configure Nginx service Istio Objects</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-createsevstest">6.3.4 Test Nginx service through testing tool</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-egress-traffic.html#06-configureegressaccess">6.4 Configure mutual TLS origination for egress traffic</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="06-egress-traffic.html#06-configureegressaccesstest">6.4.1 Testing egress traffic</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-tools.html">7. Troubleshooting Tools</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat Service Mesh - Troubleshooting</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Red Hat Service Mesh - Troubleshooting</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat Service Mesh - Troubleshooting</a></li>
    <li><a href="05-secure-ingress-traffic.html">5. Secure Ingress Traffic Troubleshooting</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/acidonper/rh-service-mesh-v2-troubleshooting/edit/master/documentation/modules/ROOT/pages/05-secure-ingress-traffic.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Service Mesh Secure Ingress Traffic Flow</h1>
<div class="sect1">
<h2 id="05-sds"><a class="anchor" href="#05-sds"></a>Secure Gateways with SDS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you know, Gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>During this step, you will review how to expose a secure HTTPS service through Openshift Router using a Gateway, a custom certificate and Istio Secret Discovery Service (SDS).</p>
</div>
<div class="sect2">
<h3 id="05-sds-addcert"><a class="anchor" href="#05-sds-addcert"></a>Create in Istio the Custom Certificate using SDS</h3>
<div class="paragraph">
<p>In order to configure a new certificate in SDS, it is required to create a new <em>secret</em> in Openshift to save the respective files.</p>
</div>
<div class="paragraph">
<p>Please, create this new <strong>secret</strong> executing the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc create -n istio-system secret tls &lt;user_namespace&gt;-credential --key=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.key --cert=./05-secure-ingress-traffic-troubleshooting/front.jumpapp.com.crt</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-secret-ok.png" alt="jump app secret ok">
</div>
<div class="title">Figure 1. Secret Created</div>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-route"><a class="anchor" href="#05-sds-route"></a>Modify back-golang Route in istio-system Namespace</h3>
<div class="paragraph">
<p>Once the new <em>secret</em> has been created, it is time to modify the back-golang OCP route in order to configure it as a <em>passthrough</em> route. With passthrough termination, encrypted traffic is sent straight to the <em>Ingress Gateway</em> without the router providing TLS termination. Therefore no key or certificate is required.</p>
</div>
<div class="paragraph">
<p>Please, modify back-golang OCP route in <strong>istio-system</strong> namespace through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/00-jump-app-golang-route.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n istio-system</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-routes-sds-mod.png" alt="jump app routes sds mod">
</div>
<div class="title">Figure 2. back-golang Route Modified</div>
</div>
</div>
<div class="sect2">
<h3 id="05-sds-gw"><a class="anchor" href="#05-sds-gw"></a>Configure Gateway</h3>
<div class="paragraph">
<p>If you remember, a gateway describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</div>
<div class="paragraph">
<p>In order to serve this new certificate when you are accessing to <em>Jump App</em> back-golang service, it is required to modify the respective Gateway.</p>
</div>
<div class="paragraph">
<p>Please, modify existing frontend <strong>gateway</strong> object executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/01-jump-app-golang-gw.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-gw-ok.png" alt="jump app gw ok">
</div>
<div class="title">Figure 3. back-golang Gateway Modified</div>
</div>
<div class="paragraph">
<p>In order to ensure the Istio Secret Discovery Service (SDS) has been configured properly, you can review the <em>istio ingress gateway</em> pod as shown the following picture:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-sds-ok.png" alt="jump app sds ok">
</div>
<div class="title">Figure 4. Secret Added to SDS</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test-fail"><a class="anchor" href="#05-test-fail"></a>Confirm <em>Jump App</em> is running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> SDS has been modified, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to review your demo app current state after the customization:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-pods-2-ok.png" alt="jump app pods 2 ok">
</div>
<div class="title">Figure 5. Jump App Pods Mesh</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok">
</div>
<div class="title">Figure 6. Jump App Routes</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-unavailable-back-route.png" alt="jump app unavailable back route">
</div>
<div class="title">Figure 7. Jump App Back Unavailable</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser.In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-unavailable-front.png" alt="jump app unavailable front">
</div>
<div class="title">Figure 8. Jump App Front with Errors</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An error message appears when the frontend tries to call backend services
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-router"><a class="anchor" href="#05-router"></a>Openshift Router &#8594; Ingress Gateway Secure Connectivity</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-ingress-router-gw-sec.png" alt="jump app ingress router gw sec">
</div>
</div>
<div class="sect2">
<h3 id="05-trou-con"><a class="anchor" href="#05-trou-con"></a><strong>Test connectivity via command line</strong></h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>OCP Routers</em> to the <em>Ingress Gateway</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in routes namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n openshift-ingress</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-routers-pods.png" alt="ocp routers pods">
</div>
<div class="title">Figure 9. OCP Router Pods</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the router pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project openshift-ingress
POD=$(oc get po -o jsonpath='{.items[0].metadata.name}' -n openshift-ingress)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:istio-ingressgateway.istio-system.svc.cluster.local:443 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-trou-05-gw.png" alt="jump app trou 05 gw">
</div>
<div class="title">Figure 10. HTTP Response 200</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Note that the <em>Ingress Gateway</em> is exposing back-golang service properly. For this reason, you can conclude the problem is located at the OCP route level
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-fix"><a class="anchor" href="#05-trou-fix"></a><strong>Fix configuration problems</strong></h3>
<div class="paragraph">
<p>After test the connectivity from the <em>OCP routers</em> to the <em>ingress gateway</em>, you should review the <em>Route</em> object configuration in order to verify its definition. Please, visit the OCP console <strong>&lt;ocp_cluster_console&gt;</strong> and review this object current state:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-ocp-trou-05.png" alt="jump app ocp trou 05">
</div>
<div class="title">Figure 11. OCP Console</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-ocp-trou-05-error.png" alt="jump app ocp trou 05 error">
</div>
<div class="title">Figure 12. OCP Console Bad Configuration</div>
</div>
<div class="paragraph">
<p>If you take a look at the <em>target port</em> closely, you can find <em>http2</em>. In order to support passthrough routes and connect with <em>Ingress Gateway</em> secure ports, it is required define a secured port. Please, <em>edit route</em>, define <em>https</em> as target port and click on <strong>[ SAVE ]</strong>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-gateway"><a class="anchor" href="#05-gateway"></a>Ingress Gateway &#8594; Envoy Sidecar Secure Connectivity</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-ingress-envoy-gw-sec.png" alt="jump app ingress envoy gw sec">
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-forcessl"><a class="anchor" href="#05-trou-gateway-forcessl"></a><strong>Force mTLS in your namespace</strong></h3>
<div class="paragraph">
<p>In Istio, <em>PeerAuthentication</em> defines how traffic will be tunneled (or not) to the sidecar. In order to force all connections are secured, it is required to create the following objects using the next command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 05-secure-ingress-traffic-troubleshooting/02-jump-app-sec-services.yaml --param-file=params.env --ignore-unknown-parameters | oc apply -f - -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-trou-05-padr.png" alt="jump app trou 05 padr">
</div>
<div class="title">Figure 13. PeerAuthentication and Destination Rule created</div>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-con"><a class="anchor" href="#05-trou-gateway-con"></a><strong>Test connectivity via command line</strong></h3>
<div class="paragraph">
<p>In order to verify the secure connectivity from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, it is required to follow the next steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods">
</div>
<div class="title">Figure 14. Istio ControlPlane Pods</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute a HTTP request using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --header "Host: back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;" back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 -v</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-trou-05-k8ssrv.png" alt="jump app trou 05 k8ssrv">
</div>
<div class="title">Figure 15. HTTP Response <em>Connection reset by peer</em></div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You are receiving <strong>curl: (56) Recv failure: Connection reset by peer</strong> because <em>PeerAuthentication STRICT</em> mode is enabled
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="05-trou-gateway-evoy-con"><a class="anchor" href="#05-trou-gateway-evoy-con"></a><strong>Emulate regular <em>Ingress Gateway</em> connectivity via command line</strong></h3>
<div class="paragraph">
<p>At this point, it is time to understand how Service Mesh generates envoy traffic internal certificates. In this step, you should be able to generate a certificate from the Istio CA in order to stablish a mTLS secure connection from the <em>Ingress Gateway</em> to the <em>Envoy Sidecar</em>, back-golang.</p>
</div>
<div class="paragraph">
<p>Please, execute the following steps in order to perform the previous tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract Istio CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
oc extract secret/istio-ca-secret --to=. -n istio-system</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-istio-ca-certs.png" alt="ocp istio ca certs">
</div>
<div class="title">Figure 16. Istio CA Certs</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a openssl configuration file in order to be able to generate a x509v3 certificate</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">cat &lt;&lt;EOF &gt; openssl.conf
[req]
default_bits = 2048
encrypt_key  = no # Change to encrypt the private key using des3 or similar
default_md   = sha256
prompt       = no
utf8         = yes
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[v3_req]
basicConstraints     = CA:FALSE
keyUsage             = digitalSignature, keyEncipherment
extendedKeyUsage     = clientAuth, serverAuth
subjectAltName       = @alt_names
[alt_names]
URI = spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account
EOF</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate request</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl req -out istio.test.csr -newkey rsa:2048 -nodes -keyout istio.test.key -subj "/"</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-istio-gen-cert-req.png" alt="ocp istio gen cert req">
</div>
<div class="title">Figure 17. New Certificate Request</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate a certificate using these CA certificates</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">openssl x509 -req -days 365 -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -in istio.test.csr -out  istio.test.crt -extensions v3_req -extfile openssl.conf</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-istio-gen-cert.png" alt="ocp istio gen cert">
</div>
<div class="title">Figure 18. New Istio CA signed Certificate</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods in <em>istio-system</em> namespace</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods -n istio-system</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-istio-controlplane-pods.png" alt="ocp istio controlplane pods">
</div>
<div class="title">Figure 19. Istio ControlPlane Pods</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy certificates to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
oc exec &lt;ingress_gateway_pod_id&gt; -- mkdir /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.crt &lt;ingress_gateway_pod_id&gt;:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp istio.test.key &lt;ingress_gateway_pod_id&gt;:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;
oc cp ca-cert.pem &lt;ingress_gateway_pod_id&gt;:/var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Connect to the <em>Ingress Gateway</em> pod</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc project istio-system
POD=$(oc get po -l app=istio-ingressgateway -o jsonpath='{.items[0].metadata.name}' -n istio-system)
oc rsh $POD
cd /var/run/secrets/workload-spiffe-credentials/tmp/&lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Perform a HTTP request to the k8s service <em>back-golang</em> using curl command</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-trou-05-k8ssrv-cert.png" alt="jump app trou 05 k8ssrv cert">
</div>
<div class="title">Figure 20. HTTP Response <em>Certificate required</em></div>
</div>
<div class="ulist">
<ul>
<li>
<p>Once again, perform a HTTP request to the k8s service <em>back-golang</em> using previous certificates in this time</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">curl --connect-to back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;:443:back-golang.&lt;user_namespace&gt;.svc.cluster.local:8442 <a href="https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/" class="bare">https://back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;/</a> -k -v --cacert ca-cert.pem --cert istio.test.crt --key istio.test.key</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-trou-05-k8ssrv-cert-ok.png" alt="jump app trou 05 k8ssrv cert ok">
</div>
<div class="title">Figure 21. HTTP Response 200</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-test"><a class="anchor" href="#05-test"></a>Confirm <em>Jump App</em> is running again</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been modified and fixed in Kiali and Openshift, it is required to follow the next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-pods-2-ok.png" alt="jump app pods 2 ok">
</div>
<div class="title">Figure 22. Jump App Pods Mesh</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-get-routes-mesh-ok.png" alt="jump app get routes mesh ok">
</div>
<div class="title">Figure 23. Jump App Routes</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-back-ok.png" alt="jump app back ok">
</div>
<div class="title">Figure 24. Jump App Back</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;</em>, route via your web browser. In addition, configure <strong>[ 1000 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
<div class="literalblock">
<div class="content">
<pre>...{"code":200,"message":"/jump - Greetings from Python!"}</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-front-jumps-ok.png" alt="jump app front jumps ok">
</div>
<div class="title">Figure 25. Jump App Front Web UI Multi Jumps</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/certs_warning.png" alt="certs warning" width="50%">
</div>
<div class="title">Figure 26. Openshift Self-signed Certificates Warning</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-kiali"><a class="anchor" href="#05-kiali"></a>Visit Kiali</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this time, <em>Jump App</em> is generating traffic flow thanks to the frontend where it was given an specific number of continuous jumps. In order to review the Service Mesh traffic flow in your project, please visit the Kiali console <strong>&lt;kiali_url&gt;</strong>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jump-app-kiali.png" alt="jump app kiali">
</div>
<div class="title">Figure 27. Kiali Console</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-ingress-traffic.html">4. Service Mesh Ingress Traffic Flow</a></span>
  <span class="next"><a href="06-egress-traffic.html">6. Egress Traffic Troubleshooting</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
